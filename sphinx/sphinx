var mysql = require('mysql');
let Sphinx = require('sphinxapi');
let q = require('q');
let sSearch = require('../db/dbHelper').sphinxSearch;
let config = require("../config/default");

const sphinx = new Sphinx({
    host: 'localhost', // default sphinx host
    port: 9312 // default sphinx TCP port
});

let sphinxSearch = function (str,idx=1,filter=9,sort=0) {
    let deferred = q.defer();
    //set the match mode
    sphinx.SetMatchMode(Sphinx.SPH_MATCH_ANY);
    //set the type filter
    sphinx.ResetFilters();
    if(filter!= 9){
        sphinx.SetFilter('category',[filter*1],false);
    }
    //set the order by collomn
    if(sort){
        sphinx.SetSortMode(Sphinx.SPH_SORT_ATTR_DESC, 'feed_time');
    }else {
        sphinx.SetSortMode(Sphinx.SPH_SORT_RELEVANCE);
    }
    //set the fetch recoders number
    idx = idx - 1;
    let offset = idx * config.pageNumber;
    sphinx.SetLimits(offset,config.pageNumber);

    // console.log(sphinx);
    sphinx.Query(convertQueryStr(str),(err,result)=>{
        if(err) throw err;
        console.log(result);
        if(result.total_found != 0 && result.matches != ''){
            sSearch(getIdsFromResult(result))
                .then(res=>{
                    res.total = result.total_found;
                    deferred.resolve(res);
                });
        }else if(result.total_found != 0 && result.matches == ''){
            deferred.resolve('finish');
        }
        else{
            deferred.resolve('zero');
        }

    });
    return deferred.promise;
};

let getIdsFromResult = function(result = {}) {
    if (typeof(result)== 'Object') {
        throw new TypeError('Result must be an object');
    } else if (!result.hasOwnProperty('matches')) {
        return [];
    }
    return result.matches.map(match => match && match.id)
        // .filter(id => {typeof (id) == 'Number'});
};

let convertQueryStr = function (queryString) {
    let qs = queryString.trim().substr(0, 30);
    let qString = qs.replace(/[:：\s,，。./]/g, "|").split('|');
    // console.log(qString);
    let qStringArr = '';
    for (let i of qString) {
        if (i) {
            qStringArr += (qStringArr.length > 0 ? ' ' : '') + i;
        }
    }
    return qStringArr;
};

module.exports.sphinxSearch = sphinxSearch;